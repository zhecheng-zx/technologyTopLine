<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>搜索页</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link href="../../css/mui.min.css" rel="stylesheet" type="text/css" />
		<link rel="stylesheet" type="text/css" href="../../css/iconfont.css" />
		<style>
			body {
				width: 100%;
				height: 100%;
				background: #fff;
			}
			
			.mui-content {
				background: #fff;
			}
			
			.search-wrapper {
				background: #3385FF;
				padding: 15px 15px 10px 15px;
				color: #fff;
			}
			
			.cancel-search {
				width: 40px;
				color: #fff;
				font-size: 13px;
				height: 30px;
				line-height: 30px;
				text-align: center;
			}
			
			.mui-search {
				width: calc(100% - 50px);
			}
			
			input.mui-input-clear {
				background: #fff;
				font-size: 12px;
				height: 30px;
				color: #333;
				margin-bottom: 10px;
			}
			
			.mui-search .mui-placeholder {
				height: 30px;
				line-height: 30px;
				text-align: left;
				left: 20px;
			}
			
			.mui-input-row.mui-search .mui-icon-clear {
				top: 5px;
			}
			
			.mui-search .mui-placeholder .mui-icon {
				font-size: 16px;
				margin-right: 3px;
			}
			
			.mui-search .mui-placeholder {
				font-size: 12px;
			}
			
			.mui-card {
				background: #3385FF;
				-webkit-box-shadow: none;
				box-shadow: none;
				margin: 10px 0px 0px;
			}
			
			.mui-card .mui-card-header {
				min-height: 36px;
				padding: 0px 0px;
				color: #eee;
				font-size: 14px;
			}
			
			.mui-card .mui-card-header>a {
				font-size: 12px;
				color: #ffffff;
			}
			
			.mui-card .mui-card-header:after {
				display: none;
			}
			
			.mui-card-content {
				height: 75px;
				overflow: hidden;
			}
			
			.wanna-search-ul {
				margin: 0;
				padding: 0;
				width: 100%;
				list-style: none;
				font-size: 0px;
			}
			
			.wanna-search-ul:before,
			.wanna-search-ul:after {
				display: table;
				content: " ";
			}
			
			.wanna-search-ul:after {
				clear: both;
			}
			
			.wanna-search-ul>li {
				display: inline-block;
				font-size: 12px;
				color: #fff;
				padding: 6px 10px;
				background: #5c9dff;
				margin-right: 5px;
				margin-bottom: 5px;
				border-radius: 3px;
			}
			
			.more-box {
				display: none;
				margin-top: 5px;
			}
			
			.more-box a {
				color: #fff;
				font-size: 11px;
			}
			
			.more-box .iconfont {
				font-size: 11px;
			}
			
			.search-history {
				padding: 15px;
			}
			
			h5.text {
				color: #333;
			}
			
			.mui-icon-trash {
				font-size: 11px;
			}
			
			.mui-icon-trash:before {
				font-size: 13px;
			}
			
			.history-ul:before {
				display: none;
			}
			
			.history-ul:after {
				left: 15px;
			}
			
			.history-ul .mui-table-view-cell {
				font-size: 13px;
				color: #666;
				width: 100%;
				padding: 8px 15px;
			}
			
			.history-ul .iconfont {
				font-size: 13px;
				margin-right: 5px;
			}
			
			.hide-wanna-search {
				display: none;
			}
			
			.show-wanna-search,
			.hide-wanna-search {
				margin: 0px;
				width: 100%;
				color: #eee;
				font-size: 14px;
			}
			/*文章列表样式*/
			
			.search-content>ul {
				margin: auto;
				padding: 0px;
			}
			
			.mui-table-view-cell>a:not(.mui-btn) {
				margin: auto;
				padding: 0px;
			}
			
			.article-title {
				font-size: 17px;
				color: #333;
				overflow: hidden;
				display: -webkit-box;
				-webkit-box-orient: vertical;
				-webkit-line-clamp: 2;
				white-space: normal;
				line-height: 25px;
				height: 50px;
			}
			
			.article-title.special {
				height: 25px;
			}
			
			.mui-table-view .mui-media-object {
				height: 75px;
				max-width: 103px;
			}
			
			p.mui-ellipsis {
				font-size: 11px;
				color: #999;
				margin-top: 4px;
			}
			
			.mui-media .iconfont {
				vertical-align: middle;
			}
			
			.mui-media-body ul.mui-grid-view {
				padding: 0px;
			}
			
			.mui-media-body ul.mui-grid-view:before {
				height: 0px;
			}
			
			.mui-media-body ul.mui-grid-view:after {
				height: 0px;
			}
			
			.mui-media-body ul.mui-grid-view li.mui-table-view {
				display: inline-block;
				padding: 10px 0 0 0px;
				text-align: center;
				vertical-align: middle;
				background: 0 0;
			}
			
			.mui-media-body ul.mui-grid-view li:not(:last-child) {
				padding-right: 5px;
			}
			
			.mui-media-body ul.mui-grid-view li.mui-table-view:before,
			.mui-media-body ul.mui-grid-view li.mui-table-view:after {
				height: 0px;
			}
			
			.mui-media-body ul.mui-grid-view li.mui-table-view img {
				max-width: 100%;
				width: 100%;
			}
		</style>
	</head>

	<body>
		<div class="mui-content mui-scroll-wrapper">
			<div class="search-wrapper">
				<div class="search-box mui-clearfix">
					<div class="mui-input-row mui-search mui-pull-left">
						<input type="search" class="mui-input-clear" placeholder="请输入关键字" id="searchInput">
					</div>
					<a href="javascript:;" class="text mui-pull-right cancel-search" id="cancelSearch">取消</a>
				</div>
				<div class="mui-card wanna-search-box">
					<!--页眉，放置标题-->
					<div class="mui-card-header">
						<p class="show-wanna-search">
							猜你想搜的
							<span class="mui-icon iconfont icon-DLS_Hide_ mui-pull-right"></span>
						</p>
						<p class="hide-wanna-search mui-text-center">
							<span class="mui-icon iconfont icon-eye"></span> 查看全部推荐词
						</p>
					</div>
					<!--内容区-->
					<div class="mui-card-content">
						<ul class="wanna-search-ul" id="wannaSearchUl">
							<li data-li="1">
								科技驱动创新
							</li>
							<li data-li="2">
								铝基新材料
							</li>
							<li data-li="3">
								3D打印材料
							</li>
							<li data-li="4">
								互联网经济
							</li>
							<li data-li="5">
								纳米制造技术
							</li>
							<li data-li="6">
								石墨烯
							</li>
							<li data-li="7">
								跨境电商
							</li>
							<li data-li="8">
								智慧旅游
							</li>
							<li data-li="9">
								互联网金融
							</li>
						</ul>
					</div>
					<div class="more-box mui-text-center">
						<a href="javascript:;" id="searchMore">
							<span class="text">查看更多</span>
							<span class="mui-icon iconfont icon-down"></span>
						</a>
					</div>
				</div>
			</div>
			<div class="search-history">
				<h5 class="text">搜索历史
					<p class="mui-pull-right">
						<span class="mui-icon mui-icon-trash">清空</span>
					</p>
				</h5>
				<ul class="mui-table-view history-ul" id="history-ul">
					<li class="mui-table-view-cell">
						<span class="mui-icon iconfont icon-liulanjilu"></span>大数据人工智能
						<span class="mui-icon ui-icon mui-icon-closeempty mui-pull-right"></span>
					</li>
					<li class="mui-table-view-cell">
						<span class="mui-icon iconfont icon-liulanjilu"></span>新能源汽车
						<span class="mui-icon ui-icon mui-icon-closeempty mui-pull-right"></span>
					</li>
					<li class="mui-table-view-cell">
						<span class="mui-icon iconfont icon-liulanjilu"></span>海洋资源
						<span class="mui-icon ui-icon mui-icon-closeempty mui-pull-right"></span>
					</li>
				</ul>
			</div>
			<div class="search-content mui-scroll">
				<ul id="articleUl" class="mui-table-view"></ul>
			</div>
		</div>
		<script src="../../vendor/jQuery/jquery.min.js"></script>
		<script src="../../js/mui.min.js"></script>
		<script>
			var pageSize = 10,
				pageNum = 1;
			mui.init({
				pullRefresh: {
					container: '.search-content',
					up: {
						height: 50,
						auto: false,
						contentrefresh: '正在加载...',
						contentnomore: '没有更多数据了',
						callback: pullupRefresh
					}
				}
			});
			$(document).ready(function() {
				//猜你想搜的   查看更多是否显示
				var $box = $('.more-box');
				if($('.wanna-search-ul').height() > 110) {
					$box.show();
				} else {
					$box.hide();
				}
			});

			mui('.mui-content').on('tap', '#searchMore', function() {
				var $content = $('.mui-card-content'),
					$moreText = $('#searchMore .text'),
					$moreIcon = $('#searchMore .mui-icon');

				if($content.height() == 75) {
					var ulHeight = $('.wanna-search-ul').height();
					$content.height(ulHeight);
					$moreText.text('收起');
					$moreIcon.removeClass('icon-down').addClass('icon-up');
				} else {
					$content.height(75);
					$moreText.text('查看更多');
					$moreIcon.addClass('icon-down').removeClass('icon-up');
				}
			});

			mui('.mui-content').on('tap', '#cancelSearch', function() {
				document.getElementById('searchInput').value = '';
				mui.back();
			});

			var nativeWebview, imm, InputMethodManager;
			var initNativeObjects = function() {
				if(mui.os.android) {
					var main = plus.android.runtimeMainActivity();
					var Context = plus.android.importClass("android.content.Context");
					InputMethodManager = plus.android.importClass("android.view.inputmethod.InputMethodManager");
					imm = main.getSystemService(Context.INPUT_METHOD_SERVICE);
				} else {
					nativeWebview = plus.webview.currentWebview().nativeInstanceObject();
				}
			};
			var showSoftInput = function() {
				var nativeWebview = plus.webview.currentWebview().nativeInstanceObject();
				if(mui.os.android) {
					//强制当前webview获得焦点
					plus.android.importClass(nativeWebview);
					nativeWebview.requestFocus();
					imm.toggleSoftInput(0, InputMethodManager.SHOW_FORCED);
				} else {
					nativeWebview.plusCallMethod({
						"setKeyboardDisplayRequiresUserAction": false
					});
				}
				setTimeout(function() {
					//此处可写具体逻辑设置获取焦点的input
					var inputElem = document.querySelector('input');
					inputElem.focus();
				}, 250);
			};
			mui.plusReady(function() {
				initNativeObjects();
				showSoftInput();
			});

			//是否隐藏 猜你想搜 内容
			mui('.mui-content').on('tap', '.icon-DLS_Hide_', function() {
				$('.hide-wanna-search').show();
				$('.show-wanna-search').hide();
				$('.mui-card-content').hide();
				$('.more-box').hide();
			});

			mui('.mui-content').on('tap', '.hide-wanna-search', function() {
				$('.hide-wanna-search').hide();
				$('.show-wanna-search').show();
				$('.mui-card-content').show();
			});

			mui('.mui-content').on('change', '#searchInput', function(e) {
				var val = $(this).val();
				console.log(val)
				if(!val) {
					$('#articleUl').empty();
					$('.hide-wanna-search').hide();
					$('.show-wanna-search').show();
					$('.mui-card-content').show();
				}
			});

			function pullupRefresh() {
				if($('.search-content').is(':hidden')){
					return ;
				}
				pageNum = pageNum + 　1;
				searchArticle($('#searchInput').val());
			}

			document.getElementById('searchInput').addEventListener('keydown', function(e) {
				if(13 == e.keyCode) {
					var text = this.value;
					if(!text) {
						mui.toast('请输入要搜索的内容');
						return;
					}
					document.activeElement.blur(); //隐藏软键盘 
					$('.wanna-search-box').hide();
					$('.search-history').hide();
					$('.search-content').show();
					var _li = '<li class="mui-table-view-cell">' +
						'<span class="mui-icon iconfont icon-liulanjilu"></span>' + text +
						'<span class="mui-icon ui-icon mui-icon-closeempty mui-pull-right"></span>' +
						'</li>';
					$('#history-ul').prepend(_li);
					//清空旧数据
					$('#articleUl').empty();
					//加载中
					var w = plus.nativeUI.showWaiting('搜索中');
					searchArticle(text, w);
				}
			});

			mui('.search-box').on('tap', '.mui-icon-clear', function(e) {
				$('.wanna-search-box').show();
				$('.search-history').show();
				$('.search-content').empty().hide();
			});

			mui('.history-ul').on('tap', '.mui-icon-closeempty', function() {

			});

			//请求数据 添加数据	
			function searchArticle(text, w) {
				mui.ajax('http://58.16.181.24:9203/mis-app/VisitingCard/articleType', {
					data: {
						page_no: pageNum,
						page_size: pageSize,
						sortType: 'desc',
						sortField: 'publishTime',
						all: text
					},
					success: function(data) {
						var list = data.list;
						if(list.length == 0){
							 this.endPullupToRefresh(true);
						}else{
							addData(list);
						}
						
						if(w){
							w.close();
						}
					},
					error: function(xhr, type, errorThrown) {
						//异常处理；
						console.error(xhr);
						console.error(type);
					}
				});
			}

			function addData(articleList) {
				var table = $('#articleUl');
				for(var i = 0; i < articleList.length; i++) {
					var img = articleList[i].images;
					var $li = $('<li class="mui-table-view-cell mui-media"></li>');

					//根据图片个数 显示不同的样式列表
					if(!img) {
						$li.append('<a javascript:; data-guid="' + articleList[i].id + '">' +
							'<div class="mui-media-body">' +
							'<div class="article-title">' + articleList[i].title + '</div>' +
							'<p class="mui-ellipsis">' +
							'<span class="source">' + articleList[i].siteName + '</span> &nbsp;&nbsp;' +
							'<span class="time">' + formatDate(articleList[i].publishTime) + '</span></p>' +
							'</div>' +
							'</a>');
					} else if(img.length < 3) {
						$li.append('<a javascript:; data-guid="' + articleList[i].id + '">' +
							'<img class="mui-media-object mui-pull-right" src="' + img[0] + '">' +
							'<div class="mui-media-body">' +
							'<div class="article-title">' + articleList[i].title + '</div>' +
							'<p class="mui-ellipsis">' +
							'<span class="source">' + articleList[i].siteName + '</span> &nbsp;&nbsp;' +
							'<span class="time">' + formatDate(articleList[i].publishTime) + '</span></p>' +
							'</div>' +
							'</a>');
					} else {
						var imgUl = '<ul class="mui-table-view mui-grid-view">';
						for(var j = 0; j < 3; j++) {
							imgUl = imgUl + '<li class="mui-table-view mui-media mui-col-xs-4"><img class="mui-media-object" src="' + img[j] + '"></li>';
						}
						imgUl += '</ul>';
						$li.append('<a javascript:; data-guid="' + articleList[i].id + '">' +
							'<div class="mui-media-body">' +
							'<div class="article-title special">' + articleList[i].title + '</div>' +
							imgUl +
							'</div>' +
							'</a>' +
							'<p class="mui-ellipsis">' +
							'<span class="source">' + articleList[i].siteName + '</span> &nbsp;&nbsp;' +
							'<span class="time">' + formatDate(articleList[i].publishTime) + '</span>' +
							'</p>'
						);
					}

					table.append($li);
				}
			}

			function formatDate(date) {
				var date1 = new Date(date),
					now = new Date();
				var milliseconds = now.getTime() - date1.getTime(),
					timeSpanStr = '';
				if(milliseconds <= 1000 * 60 * 1) {
					timeSpanStr = '刚刚';
				} else if(1000 * 60 * 1 < milliseconds && milliseconds <= 1000 * 60 * 60) {
					timeSpanStr = Math.round((milliseconds / (1000 * 60))) + '分钟前';
				} else if(1000 * 60 * 60 * 1 < milliseconds && milliseconds <= 1000 * 60 * 60 * 24) {
					timeSpanStr = Math.round(milliseconds / (1000 * 60 * 60)) + '小时前';
				} else if(1000 * 60 * 60 * 24 < milliseconds && milliseconds <= 1000 * 60 * 60 * 24 * 15) {
					timeSpanStr = Math.round(milliseconds / (1000 * 60 * 60 * 24)) + '天前';
				} else {
					timeSpanStr = date.substring(5, 10) + ' ' + date.substring(11, 16);
				}
				return timeSpanStr;
			}

			/**
			 * 打开新闻详情
			 * 
			 * @param {String} guid 新闻ID
			 * @param {String} title  新闻标题
			 */

			function open_detail(guid, title, source, time) {
				mui.openWindow({
					url: 'articleDetail.html',
					id: 'articleDetail',
					waiting: {
						autoShow: true,
						title: '正在加载...'
					},
					extras: {
						title: title, //扩展参数
						guid: guid,
						source: 　source,
						time: time
					}
				});
			}

			$(document).on('tap', '.mui-table-view li>a', function(e) {
				e.stopPropagation();
				e.preventDefault();
				var _this = $(this);
				var guid = _this.attr('data-guid'),
					title = _this.find('.article-title').text().trim(),
					source = _this.find('.source').text().trim(),
					time = _this.find('.time').text().trim();
				open_detail(guid, title, source, time);
			});
		</script>
	</body>

</html>